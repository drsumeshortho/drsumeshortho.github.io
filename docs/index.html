// ✅ OrthoCure Code.gs – Auto-sync with CRM Enabled
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);

    const htmlSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("HTML Submissions");
    const crmSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Patient CRM");

    const row = [
      new Date(),
      data.Name || "",
      data.Age || "",
      data.Gender || "",
      data.Phone || "",
      data.Email || "",
      data.Problem || "",
      data.ConsultationDay || "",
      data.PreferredTime || "",
      data.PreferredExactTime || "",
      `https://wa.me/91${data.Phone}?text=Hi%20${encodeURIComponent(data.Name)},%20this%20is%20Dr.%20Sumesh%20from%20OrthoCure.`,
      data.Consent || ""
    ];
    htmlSheet.appendRow(row);

    // ✅ Auto-sync with CRM
    const crmData = crmSheet.getDataRange().getValues();
    let found = false;
    for (let i = 1; i < crmData.length; i++) {
      if (crmData[i][3] == data.Phone) {
        crmSheet.getRange(i + 1, 6).setValue(new Date()); // Update Last Visit
        crmSheet.getRange(i + 1, 7).setValue(new Date()); // Update Last Updated
        found = true;
        break;
      }
    }

    if (!found) {
      crmSheet.appendRow([
        data.Name || "",
        data.Age || "",
        data.Gender || "",
        data.Phone || "",
        data.Email || "",
        new Date(), // First Visit
        new Date(), // Last Updated
        data.Problem || "",
        1,
        "₹0"
      ]);
    }

    return ContentService.createTextOutput(JSON.stringify({ status: "ok" }))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeader("Access-Control-Allow-Origin", "*")
      .setHeader("Access-Control-Allow-Methods", "POST")
      .setHeader("Access-Control-Allow-Headers", "Content-Type");
  } catch (err) {
    const htmlSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("HTML Submissions");
    htmlSheet.appendRow(["ERROR", new Date(), err.message]);
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: err.message }))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeader("Access-Control-Allow-Origin", "*");
  }
}
